---
name: SLSA Docker Release
on:
    push:
        tags:
            - "v*"

permissions:
    contents: read
    id-token: write
    packages: write
    actions: read
    attestations: write

env:
    IMAGE_NAME: tinyapi
    REGISTRY: ghcr.io

jobs:
    build-and-push-image:
        name: Build and Push Image to GitHub Container Registry
        runs-on: ubuntu-latest
        outputs:
            image_path: ${{ steps.image-meta.outputs.image_path }}
            digest: ${{ steps.push-to-ghcr.outputs.digest }}
            registry_username: ${{ steps.image-meta.outputs.actor }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Set image metadata
              id: image-meta
              run: |
                  OWNER="${{ github.repository_owner }}"
                  OWNER="${OWNER,,}"
                  ACTOR="${{ github.actor }}"
                  ACTOR="${ACTOR,,}"
                  IMAGE_NAME="${{ env.IMAGE_NAME }}"
                  REGISTRY="${{ env.REGISTRY }}"
                  IMAGE_PATH="${REGISTRY}/${OWNER}/${IMAGE_NAME}"
                  echo "owner=${OWNER}" >> "$GITHUB_OUTPUT"
                  echo "actor=${ACTOR}" >> "$GITHUB_OUTPUT"
                  echo "image_name=${IMAGE_NAME}" >> "$GITHUB_OUTPUT"
                  echo "image_ref=${OWNER}/${IMAGE_NAME}" >> "$GITHUB_OUTPUT"
                  echo "image_path=${IMAGE_PATH}" >> "$GITHUB_OUTPUT"
                  echo "release_tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
                  echo "latest_tag=latest" >> "$GITHUB_OUTPUT"

            - name: Build with Buildah
              uses: redhat-actions/buildah-build@v2
              with:
                  image: ${{ steps.image-meta.outputs.image_ref }}
                  tags: |
                      ${{ steps.image-meta.outputs.release_tag }}
                      ${{ steps.image-meta.outputs.latest_tag }}
                  containerfiles: |
                      ./Dockerfile

            - name: Login to ghcr.io
              uses: redhat-actions/podman-login@v1
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ steps.image-meta.outputs.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Push to GitHub Container Registry
              id: push-to-ghcr
              uses: redhat-actions/push-to-registry@v2
              with:
                  image: ${{ steps.image-meta.outputs.image_ref }}
                  tags: |
                      ${{ steps.image-meta.outputs.release_tag }}
                      ${{ steps.image-meta.outputs.latest_tag }}
                  registry: ${{ env.REGISTRY }}

            - name: Create GitHub attestation
              uses: actions/attest-build-provenance@v1
              with:
                  subject-name: ${{ steps.image-meta.outputs.image_path }}
                  subject-digest: ${{ steps.push-to-ghcr.outputs.digest }}

            - name: Print image url
              run: |
                  echo "Image pushed to ${{ steps.push-to-ghcr.outputs.registry-paths }}"

    attest-image:
        needs: [build-and-push-image]
        permissions:
            contents: write
            id-token: write
            actions: read
            packages: write

        uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
        with:
            image: ${{ needs.build-and-push-image.outputs.image_path }}
            digest: ${{ needs.build-and-push-image.outputs.digest }}
            registry-username: ${{ needs.build-and-push-image.outputs.registry_username }}
            continue-on-error: true # Apparently the SLSA team can't debug or document this thing, so we're babysitting their spaghetti.
        secrets:
            registry-password: ${{ secrets.GITHUB_TOKEN }}
...
